name: Deploy P3 Lambda File Processor

on:
  push:
    branches: [main, dev]

env:
  AWS_DEFAULT_REGION: us-east-1

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Test Lambda function
        run: |
          cd lambda-code
          python -c "
          import lambda_function
          print('âœ… Lambda function syntax is valid')
          
          # Basic test
          test_event = {'httpMethod': 'POST', 'body': '{\"test\": \"data\"}'}
          result = lambda_function.lambda_handler(test_event, {})
          print('âœ… Lambda function test passed')
          print('Status Code:', result.get('statusCode'))
          "

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS Connection
        run: |
          echo "ğŸ”‘ Testing AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

      - name: Update Lambda Function
        run: |
          cd lambda-code
          
          echo "ğŸ“¦ Packaging Lambda function..."
          zip lambda_function.zip lambda_function.py
          
          echo "ğŸš€ Updating Lambda function..."
          aws lambda update-function-code \
            --function-name P3-lambda-file-processor \
            --zip-file fileb://lambda_function.zip
          
          echo "âœ… Lambda function updated successfully!"

      - name: Test Deployment
        run: |
          echo "ğŸ§ª Testing Lambda function..."
          
          # Test Lambda directly
          aws lambda invoke \
            --function-name P3-lambda-file-processor \
            --payload '{"httpMethod": "POST", "body": "{\"test\": \"CI/CD deployment\", \"timestamp\": \"'$(date)'\"}", "path": "/process"}' \
            response.json
          
          echo "ğŸ“„ Lambda Response:"
          cat response.json
          echo ""
          
          # Test API Gateway
          echo "ğŸŒ Testing API Gateway..."
          API_URL="https://5xk43i586d.execute-api.us-east-1.amazonaws.com/dev/process"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d '{"test": "CI/CD API test", "source": "GitHub Actions", "timestamp": "'$(date)'"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… API Gateway test successful!"
          else
            echo "âš ï¸ API Gateway returned status $HTTP_CODE"
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "ğŸ‰ === P3 Lambda File Processor - Deployment Complete! ==="
          echo ""
          echo "ğŸ“ Infrastructure:"
          echo "   â€¢ Lambda Function: P3-lambda-file-processor"
          echo "   â€¢ S3 Bucket: p3-lambda-file-processor-uploads"
          echo "   â€¢ API Gateway: https://5xk43i586d.execute-api.us-east-1.amazonaws.com/dev/process"
          echo ""
          echo "ğŸ§ª Test Your Deployment:"
          echo "   â€¢ API Test:"
          echo "     curl -X POST 'https://5xk43i586d.execute-api.us-east-1.amazonaws.com/dev/process' \\"
          echo "          -H 'Content-Type: application/json' \\"
          echo "          -d '{\"test\": \"manual\"}'"
          echo ""
          echo "   â€¢ S3 Upload Test:"
          echo "     echo 'Test file' > test.txt"
          echo "     aws s3 cp test.txt s3://p3-lambda-file-processor-uploads/"
          echo ""
          echo "âœ… Project 3 - AWS Lambda File Processor is LIVE!"
          echo "ğŸ† Ready for portfolio presentation!"
